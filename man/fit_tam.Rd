% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit.R
\name{fit_tam}
\alias{fit_tam}
\title{Fit a Tiny Assessment Model (TAM)}
\usage{
fit_tam(
  obs,
  interval = 0.95,
  add_osa_res = FALSE,
  silent = FALSE,
  start_par = NULL,
  ...
)
}
\arguments{
\item{obs}{A named list of tidy observation tables (e.g., \code{catch}, \code{index},
\code{weight}, \code{maturity}). See \link{cod_obs} for an example.}

\item{interval}{Level in \verb{(0, 1)} to use to generate confidence intervals,
where applicable; default \verb{0.95.}}

\item{add_osa_res}{Logical; add one-step-ahead residuals? Hard wired to
apply the \code{"oneStepGaussianOffMode"} method. See \code{\link[RTMB:OSA-residuals]{RTMB::oneStepPredict()}}
for details.}

\item{silent}{Logical; if \code{TRUE}, disables tracing information.}

\item{start_par}{Optional list of starting parameter values, matching the
structure returned by \code{\link[=make_par]{make_par()}}. Useful for warm starts or retrospective
runs where parameter estimates from a previous fit are reused to improve
convergence and speed. Non-matching or missing entries are ignored.}

\item{...}{
  Arguments passed on to \code{\link[=make_dat]{make_dat}}
  \describe{
    \item{\code{years}}{Integer vector of model years (strictly increasing).
Inferred from observed data (non-projection) if \code{NULL}.}
    \item{\code{ages}}{Integer vector of model ages (strictly increasing).
Inferred from observed data (non-projection) if \code{NULL}.}
    \item{\code{N_settings}}{A list with elements:
\itemize{
\item \code{process}: one of \code{"off"}, \code{"iid"}, \code{"approx_rw"}, or \code{"ar1"}.
\item \code{init_N0}: logical; if \code{TRUE}, estimate an initial level for the
first-year abundance. If \code{process == "off"} and \code{init_N0 == FALSE},
this is forced to \code{TRUE}.
}}
    \item{\code{F_settings}}{A list with elements:
\itemize{
\item \code{process}: one of \code{"iid"}, \code{"approx_rw"}, or \code{"ar1"}.
\item \code{mu_form}: an optional formula for mean-\eqn{F}.
\item \code{mean_ages}: optional vector of ages to include in population weighted
average F (\code{F_bar}) calculations. All ages used if absent.
}}
    \item{\code{M_settings}}{A list with elements:
\itemize{
\item \code{process}: one of \code{"off"}, \code{"iid"}, \code{"approx_rw"}, or \code{"ar1"}.
\item \code{mu_form}: optional formula for mean-\eqn{M} (on the log scale) built
on \code{obs$weight}. If provided together with \code{assumption}, the intercept
in \code{mu_form} is dropped (warning) so assumed levels act as fixed offsets.
\item \code{assumption}: optional one-sided formula giving fixed (non-estimated)
log-\eqn{M} offsets, e.g. \code{~ I(0.2)} or a column reference such as
\code{~ log(M_assumption)} stored in the \code{obs$weight} data.frame.
\item \code{age_breaks}: optional integer break points used by \code{\link[=cut_ages]{cut_ages()}} to
define \code{age_blocks} for coupling \eqn{M} deviations across ages.
When a narrower set of \code{age_breaks} than modeled \code{ages} is provided,
deviations are only estimated for ages within the specified range; ages
outside this range are fixed to their mean or assumed levels. By default,
deviations are estimated for all modeled ages except the youngest, reducing
confounding between \eqn{M} and recruitment.
\item \code{first_dev_year}: integer year at which to start estimating \eqn{M} deviations.
Defaults to the second modeled year if \code{NULL}. Anchoring the first year
to mean or assumed levels helps minimize confounding between early \eqn{M}
estimates, initial abundance, and catchability, leading to more stable estimation.
\item \code{mean_ages}: optional vector of ages to include in population weighted
average M (\code{M_bar}) calculations. All ages used if absent.
}}
    \item{\code{obs_settings}}{A list with elements:
\itemize{
\item \code{sd_catch_form}: formula for observation SD blocks for catch-at-age data.
\item \code{sd_index_form}: formula for observation SD blocks for index-at-age data.
\item \code{q_form}: formula for catchability blocks, evaluated on the index table (e.g. \code{~ q_block}).
\item \code{fill_missing}: logical - fill missing values, and zeros, using random effects? Default = \code{TRUE}.
Note that one-step-ahead residuals are not currently working when \code{TRUE}.
}}
    \item{\code{proj_settings}}{Optional list with elements:
\itemize{
\item \code{n_proj}: number of years to project (default \code{NULL} disables projections).
\item \code{n_mean}: number of terminal years to average when adding projection rows.
\item \code{F_mult}: multiplier to apply to terminal F to set a level to carry forward in the projection years
(default = \code{1} to assume status quo F through the projection years). Can be a value of length 1 or
length = \code{n_proj}. When it is a vector of length one, that multiplier is recycled across all
projection years.
}}
  }}
}
\value{
A list with components:
\itemize{
\item \strong{call}: matched call.
\item \strong{dat}: data list returned by \code{\link[=make_dat]{make_dat()}}.
\item \strong{obj}: RTMB \code{ADFun} object.
\item \strong{opt}: \verb{[stats::nlminb()]} optimization result.
\item \strong{rep}: list from \code{obj$report()}.
\item \strong{sdrep}: \code{\link[RTMB:TMB-interface]{RTMB::sdreport()}} result.
\item \strong{fixed_par}: fixed parameter estimates in a tidy format (see \code{\link[=tidy_par]{tidy_par()}}).
\item \strong{random_par}: list of random parameter estimates in a tidy format (see
\code{\link[=tidy_par]{tidy_par()}}).
\item \strong{is_converged}: Did the model converge? (see \code{\link[=check_convergence]{check_convergence()}})
\item \strong{obs_pred}: \code{obs$catch} and \code{obs$index} data augmented with
predicted values, parameter estimates, and
standardized residuals (see \code{\link[=tidy_obs_pred]{tidy_obs_pred()}}).
\item \strong{pop}: A collection of population summaries in tidy format (see
\code{\link[=tidy_pop]{tidy_pop()}}).
}
}
\description{
Builds data with \code{\link[=make_dat]{make_dat()}}, initializes parameters with \code{\link[=make_par]{make_par()}},
constructs the RTMB objective, optimizes it, and returns a fitted object with
reports and standard errors.
}
\details{
Random-effect blocks are chosen automatically from the model settings:
\itemize{
\item Always includes \code{log_f} and \code{log_r}.
\item Includes \code{missing} if there are missing observations.
\item Includes \code{log_n} if \code{N_settings$process != "off"}.
\item Includes \code{log_m} if \code{M_settings$process != "off"}.
}

A warning is issued if the number of random effects exceeds 1.5 times the
number of observed data points (rough identifiability check).
}
\examples{
fit <- fit_tam(
  cod_obs,
  years = 1983:2024, ages = 2:14,
  N_settings = list(process = "iid", init_N0 = FALSE),
  F_settings = list(process = "approx_rw"),
  M_settings = list(process = "off", assumption = ~ I(0.3)),
  obs_settings = list(sd_catch_form = ~1, sd_index_form = ~1, q_form = ~ q_block)
)
fit$sdrep

## Fit with projections (status quo F)
fit2 <- update(fit,
  proj_settings = list(n_proj = 3, n_mean = 3, F_mult = 1)
)

if (interactive()) {
  fits <- list("without_proj" = fit, "with_proj" = fit2)
  vis_tam(fits)
}

}
\seealso{
\code{\link[=make_dat]{make_dat()}}, \code{\link[=make_par]{make_par()}}, \code{\link[=sim_tam]{sim_tam()}}, \code{\link[=fit_retro]{fit_retro()}},
\code{\link[RTMB:TMB-interface]{RTMB::MakeADFun()}}, \code{\link[RTMB:TMB-interface]{RTMB::sdreport()}}
}
